name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # Required to post PR comments/reviews
      issues: write         # Required to post issue comments
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Comprehensive Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review PR ${{ github.repository }}/pull/${{ github.event.pull_request.number }} with comprehensive structure:

            ## Summary
            Brief overview (2-3 sentences)

            ## Strengths
            What's done well?

            ## Security Concerns
            Vulnerabilities? ğŸ”´ BLOCKING | ğŸŸ¡ HIGH | ğŸŸ¢ LOW

            ## Problems
            Critical issues blocking merge (mark ğŸ”´)

            ## Code Quality
            Non-blocking improvements

            ## CLAUDE.md Adherence
            âœ…/âŒ Coverage, linting, types, patterns, commits

            ## Testing
            Test quality evaluation

            ## Documentation
            Docs completeness

            ## Requests
            Medium-priority suggestions

            ## Verdict
            âœ… LGTM | ğŸ”„ CHANGES_REQUESTED | ğŸ’¬ COMMENTS
            **Reasoning:** Specific references
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options

      - name: Post Claude Review as PR Comment
        if: always() && github.event.pull_request.number
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          echo "ğŸ” Checking for Claude Code Review output..."

          # Verify gh CLI is available
          if ! command -v gh &> /dev/null; then
            echo "âŒ gh CLI not found"
            exit 1
          fi

          # Check if GITHUB_STEP_SUMMARY exists and has content
          if [ ! -f "$GITHUB_STEP_SUMMARY" ]; then
            echo "âŒ GITHUB_STEP_SUMMARY file not found"
            exit 1
          fi

          if [ ! -s "$GITHUB_STEP_SUMMARY" ]; then
            echo "âŒ GITHUB_STEP_SUMMARY is empty"
            exit 1
          fi

          echo "ğŸ“ Posting Claude Code Review to PR #${{ github.event.pull_request.number }}..."

          # Create comment body with review results
          {
            echo "## ğŸ¤– Claude Code Review"
            echo ""
            cat "$GITHUB_STEP_SUMMARY"
            echo ""
            echo "---"
            echo "*Review generated by [Claude Code](https://github.com/anthropics/claude-code-action)*"
          } > /tmp/review-comment.md

          # Verify comment file was created with content
          if [ ! -s /tmp/review-comment.md ]; then
            echo "âŒ Failed to create review comment file"
            exit 1
          fi

          echo "ğŸ“¤ Posting comment to PR..."

          # Post the review as a PR comment
          if gh pr comment ${{ github.event.pull_request.number }} \
            --body-file /tmp/review-comment.md; then
            echo "âœ… Claude review posted successfully!"
          else
            echo "âŒ Failed to post review comment"
            exit 1
          fi
