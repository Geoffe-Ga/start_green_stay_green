# Tool Configuration Auditor

**Script**: `scripts/audit_tool_configs.py`
**Issue**: #132
**Purpose**: Automated tool configuration auditor to detect and resolve conflicts

## Overview

The Tool Configuration Auditor uses Claude AI to analyze your project's development tool configurations and identify conflicts, overlaps, and inconsistencies.

## Features

- **Comprehensive Discovery**: Finds all tool configurations across:
  - `pyproject.toml` (ruff, black, isort, mypy, pylint, etc.)
  - `.pre-commit-config.yaml` (all hooks)
  - Standalone config files (`.ruff.toml`, `.pylintrc`, etc.)

- **AI-Powered Analysis**: Uses Claude API to:
  - Detect configuration conflicts
  - Identify duplicate checks
  - Find inconsistent settings
  - Suggest specific fixes

- **Detailed Reports**: Generates markdown reports with:
  - Severity classification (HIGH, MEDIUM, LOW)
  - Tool-specific explanations
  - Configuration fix suggestions
  - Code examples

- **Known Conflict Detection**:
  - Ruff vs Black (line length, formatting)
  - mutmut vs refurb (mutation detection)
  - Ruff vs Bandit (security rule overlap)
  - isort vs Black (import formatting)
  - Pylint vs Ruff (duplicate linting checks)

## Installation

The auditor requires the following dependencies:

```bash
pip install anthropic pyyaml toml
```

These are already included in `requirements-dev.txt` for this project.

## Usage

### Basic Usage

```bash
# Analyze current project
python scripts/audit_tool_configs.py

# Output: tool-config-audit-report.md
```

### Dry-Run Mode

```bash
# Skip API calls, use mock data
python scripts/audit_tool_configs.py --dry-run
```

### Custom Output

```bash
# Specify output location
python scripts/audit_tool_configs.py --output my-audit-report.md
```

### Verbose Mode

```bash
# Show detailed progress
python scripts/audit_tool_configs.py --verbose
```

### Apply Fixes (Coming Soon)

```bash
# Automatically apply suggested fixes
python scripts/audit_tool_configs.py --apply-fixes
```

## Environment Setup

Set your Anthropic API key:

```bash
export ANTHROPIC_API_KEY='your-api-key-here'  # pragma: allowlist secret
```

Or add to your `.env` file:

```bash
echo "ANTHROPIC_API_KEY=your-api-key" >> .env  # pragma: allowlist secret
source .env
```

## Report Structure

The generated markdown report includes:

1. **Header**: Timestamp, model used, generation metadata
2. **Summary**: Configuration count, conflict count, severity breakdown
3. **Discovered Configurations**: All found tool configs grouped by file
4. **Conflicts**: Detailed conflict reports with:
   - Severity level
   - Affected tools
   - Description and explanation
   - Specific fix suggestions
   - Code examples
5. **Next Steps**: Recommended actions

## Example Report

```markdown
# Tool Configuration Audit Report

**Generated by**: Start Green Stay Green Tool Auditor
**Timestamp**: 2026-01-27 14:30:00
**Model**: claude-sonnet-4-5-20250929

---

## Summary

- **Total Configurations Discovered**: 12
- **Total Conflicts Detected**: 3
  - HIGH Severity: 1
  - MEDIUM Severity: 2
  - LOW Severity: 0
- **Token Usage**: 1250 input + 830 output = 2080 total

## Conflicts

### Conflict 1: Line length mismatch between Ruff and Black

**Severity**: HIGH
**Tools**: ruff, black

**Explanation**:
Ruff is configured with line-length = 100 while Black uses 88.
This will cause formatting conflicts.

**Suggestion**:
Update both tools to use the same line length (88 recommended):

```toml
[tool.ruff]
line-length = 88

[tool.black]
line-length = 88
```

---
```

## Known Conflicts

### 1. Ruff vs Black

**Issue**: Different line lengths or formatting rules
**Fix**: Ensure both use `line-length = 88` and add `COM812`, `ISC001` to Ruff's ignore list

### 2. isort vs Black

**Issue**: Import formatting differences
**Fix**: Use `profile = "black"` in isort config

### 3. Pylint vs Ruff

**Issue**: Duplicate linting checks
**Fix**: Disable overlapping checks in Pylint or Ruff

### 4. Ruff vs Bandit

**Issue**: Security rule overlap
**Fix**: Use Ruff's security rules (S*) and disable Bandit, or vice versa

### 5. mutmut vs refurb

**Issue**: Both detect mutation patterns
**Fix**: Ensure refurb ignores don't conflict with mutmut mutations

## Exit Codes

- `0`: Success
- `1`: Error (API key missing, analysis failed, etc.)
- `130`: Keyboard interrupt (Ctrl+C)

## Architecture

### Components

1. **ConfigDiscovery**: Finds and parses all tool configurations
2. **ClaudeAnalyzer**: Analyzes configurations using Claude API
3. **ReportGenerator**: Generates formatted markdown reports

### Flow

```
Project Files
    ↓
ConfigDiscovery
    ↓
Tool Configurations
    ↓
ClaudeAnalyzer (API)
    ↓
Conflict Reports
    ↓
ReportGenerator
    ↓
Markdown Report
```

## Testing

### Unit Tests

```bash
pytest tests/unit/test_audit_tool_configs.py -v
```

### Integration Tests

```bash
pytest tests/integration/test_audit_integration.py -v
```

### Coverage

```bash
pytest tests/unit/test_audit_tool_configs.py \
       tests/integration/test_audit_integration.py \
       --cov=scripts/audit_tool_configs \
       --cov-report=html
```

## Implementation Phases

- [x] **Phase 1**: Core infrastructure (discovery, API client, prompts)
- [x] **Phase 2**: Conflict detection (comprehensive tool inventory, Claude integration)
- [x] **Phase 3**: Validation & suggestions (report generation, dry-run mode)
- [ ] **Phase 4**: Auto-fix (apply suggested fixes automatically)

## Limitations

- **API Dependency**: Requires Anthropic API key and internet connection
- **Token Costs**: Each analysis consumes Claude API tokens (~1000-5000 tokens)
- **No Auto-Fix Yet**: Fixes must be applied manually (coming in Phase 4)
- **Python-Focused**: Currently optimized for Python projects

## Future Enhancements

1. **Auto-Fix Mode**: Automatically apply suggested configuration changes
2. **Multi-Language**: Support TypeScript, Go, Rust configurations
3. **Cached Analysis**: Cache results to avoid re-analyzing unchanged configs
4. **Pre-Commit Hook**: Run as pre-commit hook to prevent config drift
5. **CI Integration**: GitHub Action to comment on PRs with audit results

## Troubleshooting

### Error: ANTHROPIC_API_KEY not set

**Solution**:
```bash
export ANTHROPIC_API_KEY='your-key-here'  # pragma: allowlist secret
```

### Error: Missing dependencies

**Solution**:
```bash
pip install anthropic pyyaml toml
```

### Warning: Failed to parse config file

**Cause**: Malformed TOML or YAML syntax
**Solution**: Fix syntax errors in config file

### No conflicts detected but tools seem misconfigured

**Cause**: Dry-run mode or subtle conflicts
**Solution**: Run without `--dry-run` and review report carefully

## References

- **Issue**: [#132 - Tool Configuration Auditor](https://github.com/start-green-stay-green/issues/132)
- **Claude API**: [Anthropic Documentation](https://docs.anthropic.com)
- **Stay Green Workflow**: [reference/workflows/stay-green.md](../reference/workflows/stay-green.md)
- **Quality Standards**: [claude/quality-standards.md](../claude/quality-standards.md)

## Contributing

To extend the auditor:

1. Add new tool discovery in `ConfigDiscovery._discover_other_configs()`
2. Update prompt in `ClaudeAnalyzer._build_analysis_prompt()` with new conflict patterns
3. Add tests in `tests/unit/test_audit_tool_configs.py`
4. Update this README with new capabilities

## License

MIT License - Same as Start Green Stay Green project
